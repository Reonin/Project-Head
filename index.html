<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">

	<title>Basic Game Template</title>
<!-- Add Javascript or game libraries here-->
	<script src="libraries/jquery-2.1.3.min.js" type="text/javascript"></script><!-- Web Manipulation-->
	<script src="libraries/howler.min.js" type="text/javascript"></script> <!-- Audio, http://goldfirestudios.com/blog/104/howler.js-Modern-Web-Audio-Javascript-Library -->
	<script src="libraries/jquery.hotkeys.js" type="text/javascript"></script> <!-- Keyboard mapping, https://github.com/tzuryby/jquery.hotkeys -->
	<script src="libraries/sprite.js" type="text/javascript"></script> <!-- Sprite Mapping,  -->
    <script src="libraries/player.js" type="text/javascript"></script>
    <script src="libraries/map.js" type="text/javascript"></script> <!-- Object and Level Mapping,  -->
    <script src="libraries/tile.js" type="text/javascript"></script> <!-- Tile Mapping,  -->


</head>

<body>
	<style>
     html {
        width: 100%;
        height: 100%;
        margin: 0;
    }
    body {
        width: 100%;
        height: 100%;
        margin: 0;
        background-color: #000;
    }
	#GameCanvasScreen{
	padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;

	}
 

	</style>
<script>
//Generate the Canvas
var CANVAS_WIDTH = 1920;
var CANVAS_HEIGHT = 1080;
//HD Resolutions -1280x720 and 1920 Ã— 1080 Full HD

var canvasElement = $("<canvas id ='GameCanvasScreen' width='" + CANVAS_WIDTH + "' height='" + CANVAS_HEIGHT + "'></canvas>");
var canvas = canvasElement.get(0).getContext("2d");
canvasElement.appendTo('body');

/**By Ryan Giglio*/
function scaleToSmallest() {
    var ratio = CANVAS_WIDTH / CANVAS_HEIGHT;

    if (($(window).width() / ratio) <= $(window).height()) {
        canvasElement.css('width', '100%').css('height', 'auto');
    } else {
        canvasElement.css('height', '100%').css('width', 'auto');
    }
}
scaleToSmallest();

$(window).on('resize', function() {
    scaleToSmallest();
});
//Draw tile map
drawMap(canvas);
// Game State 


var states = {
    splash: 0,
    title: 1,
    Game: 2,
    End: 3,
    Fight:4,
    formation:5
};
var currentState = states.title;

//Game Loop
//var FPS = 60;

// shim layer with setTimeout fallback
window.requestAnimFrame = (function() {
    return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        function(callback) {
            window.setTimeout(callback, 1000 / 60);
        };
})();
//Mouse Coordinate Positioning
 function writeMessage(canvas, message) {
        var context = canvasid.getContext('2d');
        context.clearRect(0, 0, canvasid.width, canvasid.height);
        context.font = '18pt Calibri';
        context.fillStyle = 'black';
        context.fillText(message, 10, 25);
        console.log(message);
      }

function getMousePos(canvas, evt) {
        var rect = canvasid.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }

      var canvasid = document.getElementById('GameCanvasScreen');
      var context = canvas;

      // canvasid.addEventListener('mousemove', function(evt) {
      //    mousePos = getMousePos(canvasid, evt);
      //   var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
      //   writeMessage(canvas, message);
      // }, false);


var hudBar2Slide = 680;
var hudBar3Slide = 1300;

function gameloop() {
    controller();
    if (paused == false) {
    update();
    draw();
   
        //;
    }
window.requestAnimFrame(gameloop);
}

var paused = false;

 window.requestAnimFrame(gameloop);


//Keyboard Map
function setUpKeys() {
    window.keydown = {};
    window.keypress = {};
    window.keyup = {};
    function keyName(event) {
        return jQuery.hotkeys.specialKeys[event.which] ||
            String.fromCharCode(event.which).toLowerCase();
    }

    $(document).bind("keydown", function(event) {
        keydown[keyName(event)] = true;
    });

    $(document).bind("keyup", function(event) {
        keydown[keyName(event)] = false;
       // keyup[keyName(event)] = true;
    });

     $(document).bind("keypress", function(event) {
        keypress[keyName(event)] = true;
    });
};
setUpKeys();

var notyet = 0;    
function clearTimer() {
    notyet = 0;   
}  


function pauseGame() {
    if (notyet == 1) {
        console.log("waiting")
        return; 
    }  
     notyet = 1;
     paused = !paused;
     setTimeout('clearTimer()', 500);
}

//console.log(keydown.esc);


//Canvas Utlity for preventing objects from going over the edge
Number.prototype.clamp = function(min, max) {
    return Math.min(Math.max(this, min), max);
};

//Text Variables
var splashTextX = CANVAS_WIDTH / 3;
var splashTextY = 0;
var endTextX = CANVAS_WIDTH / 3;
var endTextY = 0;


var formTopTextX = CANVAS_WIDTH / 3;;
var formTopTextY = 0;

var formLeftTextX = 0;

var formRightTextX = CANVAS_WIDTH;


var topName;
var rightName;
var leftName;
var playerArray = new Array();

var punchKey;
var blockKey;
var jumpKey;
var moveKeyRight;
var moveKeyLeft;
var switchKey;


//Remove Before Testing
/*playerArray[0] = player;
playerArray[1] = player2;
playerArray[2] = player3;

playerArray[0].name = "Override";
playerArray[1].name = "Override";
playerArray[2].name = "Override";*/
/*playerArray[0].name = "Player 2";
playerArray[1].name = "Player 3";
playerArray[2].name = "Player 1";*/






//Sound creation
var GameLoopMusic_sound = new Howl({
    urls: ['sounds/spaceShooterMusic.mp3'],
    autoplay: false,
    loop: true,
});

var transformMusic_sound = new Howl({
    urls: ['sounds/transformMusic.mp3'],
    autoplay: false,
    loop: true,
});

var fightMusic_sound = new Howl({
    urls: ['sounds/fightMusic.mp3'],
    autoplay: false,
    loop: true,
});


var explosion_sound = new Howl({
    urls: ['sounds/explosion.mp3', 'sounds/explosion.wav']
});
var shoot_sound = new Howl({
    urls: ['sounds/shoot.mp3', 'sounds/shoot.wav'],
    volume: 0.2
});
var punch_sound = new Howl({
    urls: ['sounds/punch.mp3', 'sounds/punch.wav'],
    volume: 0.2
});

var evilLaugh_sound = new Howl({
    urls: ['sounds/evilLaugh.mp3', 'sounds/evilLaugh.wav'],
    volume: 0.5
});

//explosion_sound.play();



var enemies = [];

function Enemy(I) {
    I = I || {};

    I.active = true;
    I.age = Math.floor(Math.random() * 128);

    I.sprite = Sprite("enemyskull");
    // I.color = "#A2B";

    I.x = CANVAS_WIDTH / 4 + Math.random() * CANVAS_WIDTH / 2;
    I.y = 0;
    I.xVelocity = 0
    I.yVelocity = 2;

    I.width = 32;
    I.height = 32;

    I.inBounds = function() {
        return I.x >= 0 && I.x <= CANVAS_WIDTH &&
            I.y >= 0 && I.y <= CANVAS_HEIGHT;
    };

    I.draw = function() {
        //canvas.fillStyle = this.color;
        //canvas.fillRect(this.x, this.y, this.width, this.height);
        this.sprite.draw(canvas, this.x, this.y);
    };

    I.explode = function() {
        this.active = false;
        explosion_sound.play();
        // Extra Credit: Add an explosion graphic
    };

    I.update = function() {
        I.x += I.xVelocity;
        I.y += I.yVelocity;

        I.xVelocity = 3 * Math.sin(I.age * Math.PI / 64);

        I.age++;

        I.active = I.active && I.inBounds();
    };

    return I;
};


//The Fighter
var rightPunch = false;
var swungPunch = false;


var rightKick = false;
var swungKick = false;


var armBlock = false;
var blockDone = false;

var jumpDropNow = false;


var switchDone = false;
var switching = false;

var switchPhrase = "Legs";

var youCanJumpnow = true;
var youCanpunchnow = true;


var alreadyShot1 = true;
var alreadyShot2 = true;
var alreadyShot3 = true;


//EnemyVar
var leftPunch = true;

function punchTimer(){

swungPunch = false;
youCanpunchnow = false;
fighter.px =  fighter.px - 30;
console.log("hit punch Timer once");
setTimeout("dontPunch()",1000);
}

function dontPunch(){
    youCanpunchnow = true;
}
function kickTimer(){

swungKick = false;
//fighter.px =  fighter.px - 30;
  console.log("hit kick Timer once");

}

function blockTimer(){

blockDone = false;
console.log("blocked!");

}
var fighterGround = 920;
var fighterStartX = 565;

function jumpDropTimer(){
    jumpDropNow = false;
    youCanJumpnow = false;
    fighter.y = fighterGround; 
    fighter.py = fighterGround - 30;
     console.log("drop Timer once");
     setTimeout("dontJump()",1000);
}
function dontJump(){

    youCanJumpnow = true;
}
function switchPowerTimer(){

switchDone = false;

if(switching == true){
switchPhrase = "Arms";
}
else if(switching == false){
switchPhrase = "Legs";
}


console.log("Switching Power to" + switchPhrase);

}
        
//Create The player
var fighter = {
    // color: "#00A",
    sprite: Sprite("bodyTile2"),
    rightArm: Sprite("greenTile2"),
    leftArm: Sprite("greenTile2"),
    rightLeg: Sprite("emptyTile"),
    leftLeg: Sprite("emptyTile"),
    x: fighterStartX,
    y: fighterGround,
    px: fighterStartX + 70,
    py: fighterGround,
    pwidth: 64,
    pheight: 160,
    width: 64,
    height: 160,
    life: 100,
    velX: 0,
    velY: 0,
    speed: 4,
    friction: 0.85,
    draw: function() {
        //canvas.fillStyle = this.color;
        // canvas.fillRect(this.x, this.y, this.width, this.height);
        this.sprite.draw(canvas, this.x, this.y);


       // console.log(this.sprite.draw);
        if(rightPunch == true && youCanpunchnow == true){
            this.rightArm.draw(canvas, this.x + 70, this.y);
            this.leftArm.draw(canvas, this.x - 50, this.y);
/*            console.log("punch dynamics");
            console.log(this.x + 70);
            console.log(this.px + 90);*/
        }else if(armBlock == true){
             this.rightArm.draw(canvas, this.x, this.y);
             this.leftArm.draw(canvas, this.x, this.y);
        }

        else{
            this.rightArm.draw(canvas, this.x + 50, this.y);
             this.leftArm.draw(canvas, this.x - 50, this.y);
        }


       
        


      if(rightKick == true){
            //console.log(this.rightLeg);
           this.rightLeg.draw(canvas, this.x + 50, this.y + 100);
/*            console.log("punch dynamics");*/
        }else{

             this.rightLeg.save(); 

            this.rightLeg.translate(this.x + 50, this.y + 100);
            this.rightLeg.rotate(0.785); //45 degree angle
            this.rightLeg.draw(canvas, 0 , 0);

            this.rightLeg.restore();

           

        }


        this.leftLeg.draw(canvas, this.x - 50, this.y + 100);
    },
    punch: function() {
        punch_sound.play();  
    },
    block: function(){

    },
    launch: function(){
        var missilePostition = this.midpoint();
        console.log(Missle.width);
        playerMissiles.push(Missle({
            speed: 2,
            x: missilePostition.x - 500,
            y: missilePostition.y
        }))
    },
    midpoint: function() {
        return {
            x: this.x + this.width / 2,
            y: this.y + this.height / 2
        };
    },
    explode: function() {
        this.active = false;
        explosion_sound.play();
        GameLoopMusic_sound.fadeOut(0, 2000);
        currentState = states.End;
        // An explosion sound and then end the game
    },
    lifeChange: function(change) {


        this.life = this.life + change; //Adds or subtracts health based on the value added in the function

        if (this.life <= 0) {
            this.explode();
        }

        return this.life;


    }
};


var punchingBag = {
    // color: "#00A",
    sprite: Sprite("flametornado"),
    rightArm: Sprite("greenTile"),
    leftArm: Sprite("flameskull"),
    rightLeg: Sprite("emptyTile"),
    leftLeg: Sprite("emptyTile"),
    x: 1020,
    y: fighterGround,
    px: 1020 - 70,
    py: fighterGround ,
    width: 64,
    height: 160,
    pwidth: 64,
    pheight: 160,
    life: 100,
    velX: 0,
    velY: 0,
    speed: 4,
    friction: 0.85,
    scriptStep:1,
    draw: function() {

        this.sprite.draw(canvas, this.x, this.y);


        
         if(leftPunch == true){
            
            if(this.scriptStep == 1 || this.scriptStep == 2 || this.scriptStep == 3){

            this.leftArm.draw(canvas, this.x - 70, this.y);
            leftPunch = false;
           setTimeout("punchingBagPunchAi()",5000);

                    this.scriptStep = this.scriptStep + 1;

            }

            else if(this.scriptStep == 4){

                evilLaugh_sound.play();
                console.log("Imma firing my fireballz");
                setTimeout("punchingBag.shoot()", 1500);
                this.scriptStep = 1;

            }
           

        }
        else{

             this.leftArm.draw(canvas, this.x , this.y);
        }


        //this.leftArm.draw(canvas, this.x - 50, this.y);
        this.rightLeg.draw(canvas, this.x + 50, this.y + 100);
        this.leftLeg.draw(canvas, this.x - 50, this.y + 100);
    },
    punch: function() {
       // var bulletPosition = this.midpoint();

        punch_sound.play();

        
    },
    shoot: function() {
        var bulletPosition = this.midpoint();
       // shoot_sound.play();

        pbagFireballs.push(Fireball({
            speed: 3,
            x: bulletPosition.x,
            y: bulletPosition.y
        }))
    },
    midpoint: function() {
        return {
            x: this.x + this.width / 2,
            y: this.y + this.height / 2
        };
    },
    explode: function() {
        this.active = false;
        explosion_sound.play();
        GameLoopMusic_sound.fadeOut(0, 2000);
        currentState = states.End;
        console.log("YOU WON YOU DEFEATED THE PUNCHINGBAG");
        // An explosion sound and then end the game
    },
    lifeChange: function(change) {


        this.life = this.life + change; //Adds or subtracts health based on the value added in the function

        if (this.life <= 0) {
            this.explode();
        }

        return this.life;


    }
};

var pbagFireballs = [];

function punchingBagPunchAi(){
        leftPunch = true;

        punchingBag.px =  punchingBag.px - 70;
        console.log("enemy punched");
        punchingBag.punch();
        handlePbagCollisions();
        punchingBag.px =  punchingBag.px + 70;

}
function Fireball(I) {
    I.active = true;

    I.xVelocity = -I.speed;
    I.yVelocity = 0;
    I.width = 32;
    I.height = 32;

    I.color = "#F00";
    I.sprite = Sprite("fireball");

    I.inBounds = function() {
        return I.x >= 0 && I.x <= CANVAS_WIDTH &&
            I.y >= 0 && I.y <= CANVAS_HEIGHT;
    };

    I.draw = function() {
        /*canvas.fillStyle = this.color;
        canvas.fillRect(this.x, this.y, this.width, this.height);*/

        this.sprite.draw(canvas, this.x, this.y);
    };

    I.update = function() {
        I.x += I.xVelocity;
        I.y += I.yVelocity;

        I.active = I.active && I.inBounds();
    };

    return I;
}


//Collision Detection
function collides(a, b) {
    return a.x < b.x + b.width &&
        a.x + a.width > b.x &&
        a.y < b.y + b.height &&
        a.y + a.height > b.y;
}

function punchcollides(a, b) {
    return a.px < b.x + b.width &&
        a.px + a.pwidth > b.x &&
        a.py < b.y + b.height &&
        a.py + a.pheight > b.y;
}



function handleCollisions() {
    playerBullets.forEach(function(bullet) {
        enemies.forEach(function(enemy) {
            if (collides(bullet, enemy)) {
                enemy.explode();
                bullet.active = false;
                switch(bullet.bulletID){
                    case "player1":
                                    player.score(10);
                                    break;
                    case "player2":
                                    player2.score(10);
                                    break;
                    case "player3":
                                    player3.score(10);
                                    break;
                }
                

            }
        });
    });


    playerMissiles.forEach(function(missle) {
        enemies.forEach(function(enemy) {
            if (collides(missle, enemy)) {
                enemy.explode();
                missle.active = false;
            }
        });
    });

    enemies.forEach(function(enemy) {
        if (collides(enemy, player)) {
            enemy.explode();
            player.lifeChange(-10);
        }
    });

    enemies.forEach(function(enemy) {
        if (collides(enemy, player2)) {
            enemy.explode();
            player2.lifeChange(-10);
        }
    });

    enemies.forEach(function(enemy) {
        if (collides(enemy, player3)) {
            enemy.explode();
            player3.lifeChange(-10);
        }
    });

}

function handleFightCollisions() {
     if (punchcollides(fighter, punchingBag) && armBlock == false) {
                punchingBag.lifeChange(-5);
                console.log("Collliiiiiiide");
               
            }


    
}


function handlePbagCollisions(){

 
// console.log("handlePbagCollisions is firing");
             if (punchcollides(punchingBag, fighter) && armBlock == false) {
                fighter.velX--;
                fighter.lifeChange(-5);
                console.log("Punched yo face homie");
               
            }

}

function checkWinConditions(){
    

    if(player.pointScore >= 500 || player2.pointScore >= 500 || player3.pointScore >= 500 ){




        if(player.pointScore >= player2.pointScore && player.pointScore >= player3.pointScore){
            player.order = 1;
            playerArray[0] = player;
        }else if(player.pointScore >= player2.pointScore || player.pointScore >= player3.pointScore){
            player.order = 2;
            playerArray[1] = player;
        }
        else {
            player.order = 3;
            playerArray[2] = player;
        }


        if(player2.pointScore >= player.pointScore && player2.pointScore >= player3.pointScore){
            player2.order = 1;
            playerArray[0] = player2;
        }else if(player2.pointScore >= player.pointScore || player2.pointScore >= player3.pointScore){
            player2.order = 2;
            playerArray[1] = player2;
        }
        else {
            player2.order = 3;
            playerArray[2] = player2;
        }

       if(player3.pointScore >= player.pointScore && player3.pointScore >= player2.pointScore){
            player3.order = 1;
            playerArray[0] = player3;
        }else if(player3.pointScore >= player.pointScore || player3.pointScore >= player2.pointScore){
            player3.order = 2;
            playerArray[2] = playerArray[1];
            playerArray[1] = player3;
        }
        else {
            player3.order = 3;
            playerArray[2] = player3;
        }


      

        console.log(player.order);
        console.log(player2.order);
        console.log(player3.order);
        console.log("Someone won");

        GameLoopMusic_sound.stop();
        transformMusic_sound.play();
        currentState = states.formation;

    }


};
/*** Parrallax background tutorial http://javacoffee.de/?p=866 **/
//Parallax background

/** 
 * Data structure to hold layer data
 * @param s <string> Absolute path to the image
 * @param x <int> X coordinate
 * @param Y </int><int> Y coordinate
 */
function Layer(s, x, y) {
    this.img = new Image();
    this.img.src = s;
    this.x = x;
    this.y = y;
}


/**
 * Main ParallaxScrolling class
 * @param ctx <context> Canvas context
 * @param imgdata <array> Array with absolute image paths
 */
function ParallaxScrolling(canvas, imgdata) {
    var self = this;
    if (typeof imgdata === 'undefined') {
        imgdata = []; //fill it with paths to images for the parralax
    };
    this.canvas = canvas;

    // Initialize the layers
    this.layers = new Array(imgdata.length);
    for (i = 0; i < imgdata.length; i++) {
        this.layers[i] = new Layer(imgdata[i], 0, 0);
    }

    // Function: Move all layer except the first one
    this.Move = function() {
        for (var i = 1; i < self.layers.length; i++) {
            if (self.layers[i].x > self.layers[i].img.width) self.layers[i].x = 0;
            self.layers[i].x += i;
        }
    };

    // Function: Draw all layer in the canvas
    this.Draw = function() {
        self.Move();
        for (var i = 0; i < self.layers.length; i++) {
            var x1 = (self.layers[i].x - self.layers[i].img.width);
            self.canvas.drawImage(self.layers[i].img, 0, 0, self.layers[i].img.width, self.layers[i].img.height,
                self.layers[i].x, 0, self.layers[i].img.width, self.layers[i].img.height);
            self.canvas.drawImage(self.layers[i].img, 0, 0, self.layers[i].img.width, self.layers[i].img.height,
                x1, 0, self.layers[i].img.width, self.layers[i].img.height);
        }
    }
}

var layer = new Array('images/space-wall.jpg', 'images/planet.png');
var parallax = new ParallaxScrolling(canvas, layer);

function controller(){
     //Pause the game
    if (keydown.p) {

        pauseGame();
        console.log(paused);

    }

}

function update() { //Updates location and reaction of objects to the canvas




    if (currentState === states.splash) {

        //splashTextX += 1;
        splashTextY += 1;

        if (splashTextY >= 300) {

            currentState = states.title;
        }


    }



    if (currentState === states.title) {

        if (keydown.space) {

            currentState = states.Game;
        }


    }


    if (currentState === states.Game) {

        checkWinConditions();
        //Player Movement Controls
        player.movement();
        player2.movement();
        player3.movement();
        //Player actions
        if (keydown.space && alreadyShot1 == true) {
            alreadyShot1 = false;
            player.shoot();
            
        }
        if (keydown.z && alreadyShot2 == true) {
            alreadyShot2 = false;
            player2.shoot();
            
        }
        if (keydown.m && alreadyShot3 == true) {
            alreadyShot3 = false;
            player3.shoot();
            
        }
        
        playerBullets.forEach(function(bullet) {
            bullet.update();
        });

        playerBullets = playerBullets.filter(function(bullet) {
            return bullet.active;
        });


       /* if (keydown.v) {
            player.launch();
        }*/

        playerMissiles.forEach(function(missle) {
            missle.update();
        });

        playerMissiles = playerMissiles.filter(function(missle) {
            return missle.active;
        });


        //Enemy Update logic
        enemies.forEach(function(enemy) {
            enemy.update();
        });

        enemies = enemies.filter(function(enemy) {
            return enemy.active;
        });

        if (Math.random() < 0.1) {
            enemies.push(Enemy());
        }

        //Handle Collision
        handleCollisions();




    }

    if(currentState === states.formation){

        if(formRightTextX == CANVAS_WIDTH/2){

        formTopTextY += 1;
        if (formTopTextY >= 300) {

            formTopTextY = 300;

            if(formTopTextY == 300){

                if(keydown.z || keydown.space || keydown.m){
                    transformMusic_sound.stop();
                    fightMusic_sound.play();
                    currentState = states.Fight;
                }
                


            }
        }

        }
        
        //Action to skip to next screen

       
        if(formLeftTextX == CANVAS_WIDTH/3){
            formRightTextX -= 1;
        if(formRightTextX <= CANVAS_WIDTH/2){
            formRightTextX = CANVAS_WIDTH/2;
        }
        }
        


        formLeftTextX += 1;
        if(formLeftTextX >= CANVAS_WIDTH/3){
            formLeftTextX = CANVAS_WIDTH/3;
        }




        /*topName = playerArray[0].name;
        rightName = playerArray[1].name;
        leftName = playerArray[2].name;*/

    }


    if (currentState === states.End) {


        endTextY = endTextY + 1;

        if (endTextY >= 300) {

            endTextY = 300;
        }

    }



      if (currentState === states.Fight) {

        //Head controls
            if(playerArray[0].name == "Player 1"){
                moveKeyRight = keydown.right;
                moveKeyLeft = keydown.left;
                switchKey = keydown.space;
               // console.log(keydown.right);

            }else if(playerArray[0].name == "Player 2"){
                moveKeyRight = keydown.d;
                moveKeyLeft = keydown.a;
                switchKey = keydown.z;
            }else if(playerArray[0].name == "Player 3"){
                moveKeyRight = keydown.l;
                moveKeyLeft = keydown.j;
                switchKey = keydown.m;
            }else{
                 switchKey = keydown.b;
                moveKeyRight = keydown.right;
                moveKeyLeft = keydown.left;
            }

            //Arms Controls
            if(playerArray[1].name == "Player 1"){
                punchKey = keydown.right;
                blockKey = keydown.left;

            }else if(playerArray[1].name == "Player 2"){
                punchKey = keydown.d;
                blockKey = keydown.a;

            }else if(playerArray[1].name == "Player 3"){
                punchKey = keydown.l;
                blockKey = keydown.j;

            }else{
                punchKey = keydown.space;
                blockKey = keydown.x;
            }

            //Legs Control
            if(playerArray[2].name == "Player 1"){
                jumpKey = keydown.up;
               
            }else if(playerArray[2].name == "Player 2"){
                jumpKey = keydown.w;
                
            }else if(playerArray[2].name == "Player 3"){
                jumpKey = keydown.i;
               
            }else{
                
                jumpKey = keydown.up;
                
            }



        //Player Movement Controls
        if (moveKeyLeft) {
           if (fighter.velX > -fighter.speed) {
                fighter.velX--;
            }
        }

        if (moveKeyRight) {
           if (fighter.velX < fighter.speed) {
                fighter.velX++;
            }
        }

if(switchPhrase == "Legs"){
            
       
        if (jumpKey && jumpDropNow == false && youCanJumpnow == true) {
             
            if (fighter.velY > -fighter.speed) {
                if(fighter.y >= 800){

                    fighter.y = 772;
                    fighter.py = 742;
                    jumpDropNow = true;
                     window.setTimeout("jumpDropTimer()", 1000);
                    //wait 200 milliseconds and drop back down

                //fighter.velY--;
                console.log(fighter.velY--);

                }
               


            }

           
        }


 }
        if (keydown.down) {
            if (fighter.velY < fighter.speed) {
                //fighter.velY++;
            }

        }

        fighter.velX *= fighter.friction;
        fighter.x += fighter.velX;
        fighter.px += fighter.velX;
        fighter.velY *= fighter.friction;
        fighter.y += fighter.velY;

        fighter.py += fighter.velY;

        fighter.x = fighter.x.clamp(0, CANVAS_WIDTH - fighter.width); //prevents character from going past canvas

    
        fighter.y = fighter.y.clamp(0, CANVAS_HEIGHT - fighter.height); //prevents character from going past canvas


    if(switchPhrase == "Arms"){ /** Switch back to Arms before final testing***/

        if(punchKey == true && swungPunch == false && youCanpunchnow == true){
            swungPunch = true;
            rightPunch = true;
            fighter.px =  fighter.px + 30;
            console.log("punched once");
            fighter.punch();
            window.setTimeout("punchTimer()", 200);
            handleFightCollisions();
        }
        if(punchKey == false){
            rightPunch = false;
        }

        /*if(keydown.z == true && swungKick == false){
            swungKick = true;
            rightKick = true;
            //fighter.px =  fighter.px + 30;
            console.log("kicked once");
            window.setTimeout("kickTimer()", 200);
            handleFightCollisions();
        }
        if(keydown.z == false){
            rightKick = false;
        }*/
    
        
        //Block
         if(blockKey == true &&  blockDone == false){

            blockDone = true;
            armBlock = true;

        
            console.log("block once");
            window.setTimeout("blockTimer()", 800);
            handleFightCollisions();
        }
        if(blockKey == false){
            armBlock = false;
        }
    
}

        if(switchKey == true &&  switchDone == false){

            switchDone = true;
            switching = !switching;

        
            console.log("switch once");
            window.setTimeout("switchPowerTimer()", 800);
            //handleFightCollisions();
        }
       
    

        pbagFireballs.forEach(function(bullet) {
            bullet.update();
        });

        pbagFireballs = pbagFireballs.filter(function(bullet) {
            return bullet.active;
        });

        pbagFireballs.forEach(function(bullet) {
        
            if (collides(bullet, fighter)) {
                //enemy.explode();
                fighter.lifeChange(-15);
                 bullet.active = false;
                console.log("hitting the player");
                

            }
           
      
    });

        

    }



}

function draw() { //Draws objects to the canvas

    canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);




    if (currentState === states.splash) {

        canvas.fillStyle = "#000"; // Set color to black
        canvas.font = '25pt Calibri';
        var SPLASH_SCREEN_TEXT = "Ronin Rampant Games";
        splashTextX = canvas.measureText(SPLASH_SCREEN_TEXT).width;
        canvas.fillText(SPLASH_SCREEN_TEXT, (CANVAS_WIDTH / 2) - (splashTextX / 2), splashTextY);

    }


    if (currentState === states.title) {

        canvas.fillStyle = "#000"; // Set color to black
        canvas.font = 'bold 40pt Calibri';
        var GAME_NAME_TEXT = "And I'll Form the Head";
        gameTextx = canvas.measureText(GAME_NAME_TEXT).width; //Centers the text based on length
        canvas.fillText(GAME_NAME_TEXT, (CANVAS_WIDTH / 2) - (gameTextx / 2) - 3, CANVAS_HEIGHT / 3);
        //The next two create a special text effect
        canvas.fillStyle = "#F00";
        canvas.fillText(GAME_NAME_TEXT, (CANVAS_WIDTH / 2) - (gameTextx / 2), CANVAS_HEIGHT / 3);

        canvas.fillStyle = "00F";
        canvas.fillText(GAME_NAME_TEXT, (CANVAS_WIDTH / 2) - (gameTextx / 2) + 3, CANVAS_HEIGHT / 3);


        canvas.fillStyle = "#F00";
        canvas.font = 'bold 20pt Calibri';
        var SPACEBAR_TEXT = "Press Space to Continue";
        spaceBarTextx = canvas.measureText(SPACEBAR_TEXT).width; //Centers the text based on length
        canvas.fillText(SPACEBAR_TEXT, (CANVAS_WIDTH / 2) - (spaceBarTextx / 2), CANVAS_HEIGHT - CANVAS_HEIGHT / 4);



    }

    if (currentState === states.Game) {
        parallax.Draw(); //draw background
        player.draw();
        player2.draw();
        player3.draw();
        tileArray.forEach(function(tile) {
            tile.draw();
        });

        playerBullets.forEach(function(bullet) {
            bullet.draw();
        });


        playerMissiles.forEach(function(missle) {
            missle.draw();
        });

        //Enemy Draw
        enemies.forEach(function(enemy) {
            enemy.draw();
        });


        //Player 1

        canvas.fillStyle = "#fff"; // Set color to black
        canvas.font = 'bold 20pt Calibri';
        canvas.fillText("Player 1", 20, 25);

        canvas.fillStyle = "#fff"; // Set color to black
        canvas.font = '20pt Calibri';
        canvas.fillText("Score:" + player.pointScore , 115, 25);
        

        //Life Bar top is pink static background
        canvas.strokeRect(20, 40, 100 * 2, 10);
        canvas.fillStyle = "#8B8989";
        canvas.fillRect(20, 40, 100 * 2, 10);

        //Second bar is red dynamic one
        canvas.strokeRect(20, 40, 100 * 2, 10);
        canvas.fillStyle = "#F00";
        canvas.fillRect(20, 40, player.life * 2, 10);


        //Player 2

        canvas.fillStyle = "#00f"; // Set color to black
        canvas.font = 'bold 20pt Calibri';
        canvas.fillText("Player 2", hudBar2Slide, 25);

        canvas.fillStyle = "#fff"; // Set color to black
        canvas.font = '20pt Calibri';
        canvas.fillText("Score:" + player2.pointScore , hudBar2Slide + 115, 25);
        

        //Life Bar top is pink static background
        canvas.strokeRect(hudBar2Slide, 40, 100 * 2, 10);
        canvas.fillStyle = "#8B8989";
        canvas.fillRect(hudBar2Slide, 40, 100 * 2, 10);

        //Second bar is red dynamic one
        canvas.strokeRect(hudBar2Slide, 40, 100 * 2, 10);
        canvas.fillStyle = "#F00";
        canvas.fillRect(hudBar2Slide, 40, player2.life * 2, 10);


        //Player 3
        canvas.fillStyle = "#F00"; // Set color to black
        canvas.font = 'bold 20pt Calibri';
        canvas.fillText("Player 3", hudBar3Slide, 25);

        canvas.fillStyle = "#fff"; // Set color to black
        canvas.font = '20pt Calibri';
        canvas.fillText("Score:" + player3.pointScore , hudBar3Slide + 115, 25);

        //Life Bar top is pink static background
        canvas.strokeRect(hudBar3Slide, 40, 100 * 2, 10);
        canvas.fillStyle = "#8B8989";
        canvas.fillRect(hudBar3Slide, 40, 100 * 2, 10);

        //Second bar is red dynamic one
        canvas.strokeRect(hudBar3Slide, 40, 100 * 2, 10);
        canvas.fillStyle = "#F00";
        canvas.fillRect(hudBar3Slide, 40, player3.life * 2, 10);

    }


    if(currentState === states.formation){

        formTopTextX = canvas.measureText("And I'll Form The Head!!!").width;

        canvas.drawImage(playerArray[0].pilotImg, (CANVAS_WIDTH / 2) - (formTopTextX / 2), formTopTextY -267, 175, formTopTextY + 267);
        canvas.fillStyle = "#fff"; // Set color to black
        canvas.font = '25pt Calibri';
        
        canvas.fillText(playerArray[0].name + ":"+ "And I'll Form The Head!!!", (CANVAS_WIDTH / 2) - (formTopTextX / 2), formTopTextY - 250);



        canvas.drawImage(playerArray[1].pilotImg, formLeftTextX, 400, 175, 400 + 267);

        canvas.fillStyle = "#fff"; // Set color to black
        canvas.font = '25pt Calibri';
        canvas.fillText(playerArray[1].name + ":"+ "I'll Form Legs!",  formLeftTextX , 1060);
        
       
        canvas.drawImage(playerArray[2].pilotImg, formRightTextX, 400, 175, 400 + 267);

        canvas.fillStyle = "#fff"; // Set color to black
        canvas.font = '25pt Calibri';
        canvas.fillText(playerArray[2].name + ":"+"I'll Form arms!!",  formRightTextX , 1060);

    }

    if (currentState === states.End) {


        canvas.fillStyle = "#F00"; // Set color to red
        canvas.font = 'bold 45pt Calibri';

        var GameOVER_TEXT = "Game Over";
        endTextX = canvas.measureText(GameOVER_TEXT).width; //Centers the text based on length
        //canvas.fillText(GameOVER_TEXT, (CANVAS_WIDTH/2) - (GameOVER_TEXTx/2) , CANVAS_HEIGHT-CANVAS_HEIGHT/4);

        canvas.fillText(GameOVER_TEXT, (CANVAS_WIDTH / 2) - (endTextX / 2), endTextY - 90);


        canvas.fillStyle = "#000"; // Set color to black
        canvas.font = '20pt Calibri';
        endTextX = canvas.measureText("Corey Jeffers").width;
        canvas.fillText("Corey Jeffers", (CANVAS_WIDTH / 2) - (endTextX / 2), endTextY - 45);


   

    }


    if (currentState === states.Fight) {

        parallax.Draw(); //draw background
        fighter.draw();
        punchingBag.draw();

        pbagFireballs.forEach(function(bullet) {
            bullet.draw();
        });

        canvas.fillStyle = "#fff"; // Set color to black
        canvas.font = 'bold 35pt Calibri';
        canvas.fillText(playerArray[0].name + ":"+ "'Power to the " +switchPhrase +"!'" ,  fighter.x - 100 , 770);
        
        if(switchPhrase == 'Legs'){
        canvas.fillStyle = "#fff"; // Set color to black
        canvas.font = 'bold 35pt Calibri';
        canvas.fillText(playerArray[2].name + ":"+ "'Jump jets Primed!'" ,  fighter.x - 100 , 800);
        }

        else if(switchPhrase == 'Arms'){
        canvas.fillStyle = "#fff"; // Set color to black
        canvas.font = 'bold 35pt Calibri';
        canvas.fillText(playerArray[1].name + ":"+ " 'Fist ready captain!'" ,  fighter.x - 100 , 800);
        }

        //Life Bar top is pink static background *FIGHTER HEALTH BAR*
        canvas.strokeRect(20, 20, 100 * 2, 10);
        canvas.fillStyle = "#8B8989";
        canvas.fillRect(20, 20, 100 * 2, 10);

        //Second bar is red dynamic one
        canvas.strokeRect(20, 20, 100 * 2, 10);
        canvas.fillStyle = "#F00";
        canvas.fillRect(20, 20, fighter.life * 2, 10);


         //Life Bar top is pink static background *Punchingbag HEALTH BAR*
        canvas.strokeRect(CANVAS_WIDTH - 400, 20, 100 * 2, 20);
        canvas.fillStyle = "#8B8989";
        canvas.fillRect(CANVAS_WIDTH - 400, 20, 100 * 2, 20);

        //Second bar is red dynamic one
        canvas.strokeRect(CANVAS_WIDTH - 400, 20, 100 * 2, 20);
        canvas.fillStyle = "#F00";
        canvas.fillRect(CANVAS_WIDTH - 400, 20, punchingBag.life * 2, 20);


    }


}
	</script>
</body>
</html>
